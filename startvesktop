#!/usr/bin/env bash

read -ra SOCAT_ARGS <<<"${SOCAT_ARGS}"

TARGET_SOCKET="${XDG_RUNTIME_DIR}/app/com.discordapp.Discord/discord-ipc-0"
SOURCE_SOCKET="${XDG_RUNTIME_DIR}/discord-ipc-0"

invoke_socat=true
# Check if our socket already exists.
if [ -S "${TARGET_SOCKET}" ]
then
    # Check if socat is listening on it.
    if socat "${SOCAT_ARGS[@]}" -u OPEN:/dev/null "UNIX-CONNECT:${TARGET_SOCKET}"
    then
        # socat is still listening on it, make sure not not invoke it again.
        invoke_socat=false
    else
        echo "Cleaning up existing relayed socket"
        # Socket exists but socat is not listening on it (for whatever reason), delete it so we can invoke socat again.
        rm -f "${TARGET_SOCKET}"
    fi
fi

if [ "${invoke_socat}" = true ]
then
    echo "Creating relayed socket"
    socat "${SOCAT_ARGS[@]}" "UNIX-LISTEN:${TARGET_SOCKET},forever,fork" "UNIX-CONNECT:${SOURCE_SOCKET}" &
    socat_pid=$!
fi

export TMPDIR="$XDG_RUNTIME_DIR/app/${FLATPAK_ID:-dev.vencord.Vesktop}"

declare -a FLAGS=(--enable-speech-dispatcher)

if [[ $XDG_SESSION_TYPE == "wayland" && -z "$DISPLAY" ]]; then
    if [[ -c /dev/nvidia0 ]]; then
        echo "Using NVIDIA on Wayland, disabling gpu sandbox"
        FLAGS+=(--disable-gpu-sandbox)
    fi

    WAYLAND_SOCKET=${WAYLAND_DISPLAY:-"wayland-0"}
    if [[ "${WAYLAND_SOCKET:0:1}" != "/" ]]; then
        WAYLAND_SOCKET="$XDG_RUNTIME_DIR/$WAYLAND_SOCKET"
    fi

    echo "Running on native Wayland"
    FLAGS+=(--ozone-platform-hint=auto)
    FLAGS+=(--enable-wayland-ime)
    FLAGS+=(--wayland-text-input-version=3)
else
    echo "Running on X11"
    echo "To use Wayland instead, remove the --socket=x11 permission"
fi

echo "Passing the following arguments to Electron:" "${FLAGS[@]}" "$@"
zypak-wrapper /app/bin/vesktop/vesktop.bin "${FLAGS[@]}" "$@"

if [ "${invoke_socat}" = true ]
then
    echo "Removing relayed socket"
    kill -SIGTERM "${socat_pid}"
fi
